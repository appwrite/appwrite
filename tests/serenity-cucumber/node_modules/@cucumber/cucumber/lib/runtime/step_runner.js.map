{"version":3,"file":"step_runner.js","sourceRoot":"","sources":["../../src/runtime/step_runner.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,2CAAoC;AACpC,2EAAgD;AAChD,6DAA8C;AAG9C,oDAIyB;AACzB,iDAA4C;AAWrC,KAAK,UAAU,GAAG,CAAC,EACxB,cAAc,EACd,iBAAiB,EACjB,aAAa,EACb,IAAI,EACJ,cAAc,EACd,KAAK,GACO;IACZ,MAAM,SAAS,GAAG,IAAA,kBAAM,GAAE,CAAC,KAAK,EAAE,CAAA;IAClC,IAAI,KAAU,EAAE,MAAW,EAAE,cAA0C,CAAA;IAEvE,IAAI;QACF,cAAc,GAAG,MAAM,cAAc,CAAC,uBAAuB,CAAC;YAC5D,aAAa;YACb,IAAI;YACJ,KAAK;SACN,CAAC,CAAA;KACH;IAAC,OAAO,GAAG,EAAE;QACZ,KAAK,GAAG,GAAG,CAAA;KACZ;IAED,IAAI,IAAA,gCAAgB,EAAC,KAAK,CAAC,EAAE;QAC3B,MAAM,qBAAqB,GAAG,IAAA,8BAAc,EAC1C,cAAc,CAAC,OAAO,CAAC,OAAO,EAC9B,cAAc,CACf,CAAA;QAED,IAAI,cAAc,CAAC,gBAAgB,CAAC,QAAQ,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;YACxE,MAAM,IAAI,GAAG,MAAM,0BAAc,CAAC,GAAG,CAAC;gBACpC,SAAS,EAAE,cAAc,CAAC,UAAU;gBACpC,EAAE,EAAE,cAAc,CAAC,IAAI;gBACvB,OAAO,EAAE,KAAK;gBACd,qBAAqB;aACtB,CAAC,CAAA;YACF,KAAK,GAAG,IAAI,CAAC,KAAK,CAAA;YAClB,MAAM,GAAG,IAAI,CAAC,MAAM,CAAA;SACrB;aAAM;YACL,KAAK,GAAG,cAAc,CAAC,2BAA2B,EAAE,CAAA;SACrD;KACF;IAED,MAAM,QAAQ,GAAG,SAAS,CAAC,IAAI,EAAE,CAAC,QAAQ,EAAE,CAAA;IAC5C,IAAI,MAAqC,CAAA;IACzC,IAAI,OAAO,GAAG,EAAE,CAAA;IAChB,IAAI,MAAM,KAAK,SAAS,EAAE;QACxB,MAAM,GAAG,QAAQ,CAAC,oBAAoB,CAAC,OAAO,CAAA;KAC/C;SAAM,IAAI,MAAM,KAAK,SAAS,EAAE;QAC/B,MAAM,GAAG,QAAQ,CAAC,oBAAoB,CAAC,OAAO,CAAA;KAC/C;SAAM,IAAI,IAAA,6BAAa,EAAC,KAAK,CAAC,EAAE;QAC/B,OAAO,GAAG,IAAA,0BAAW,EAAC,KAAK,EAAE,iBAAiB,CAAC,CAAA;QAC/C,MAAM,GAAG,QAAQ,CAAC,oBAAoB,CAAC,MAAM,CAAA;KAC9C;SAAM;QACL,MAAM,GAAG,QAAQ,CAAC,oBAAoB,CAAC,MAAM,CAAA;KAC9C;IAED,OAAO;QACL,QAAQ;QACR,MAAM;QACN,GAAG,OAAO;KACX,CAAA;AACH,CAAC;AA5DD,kBA4DC;AAED,kBAAe,EAAE,GAAG,EAAE,CAAA","sourcesContent":["import { create } from './stopwatch'\nimport UserCodeRunner from '../user_code_runner'\nimport * as messages from '@cucumber/messages'\nimport { ITestCaseHookParameter } from '../support_code_library_builder/types'\nimport { IDefinition, IGetInvocationDataResponse } from '../models/definition'\nimport {\n  doesHaveValue,\n  doesNotHaveValue,\n  valueOrDefault,\n} from '../value_checker'\nimport { formatError } from './format_error'\n\nexport interface IRunOptions {\n  defaultTimeout: number\n  filterStackTraces: boolean\n  hookParameter: ITestCaseHookParameter\n  step: messages.PickleStep\n  stepDefinition: IDefinition\n  world: any\n}\n\nexport async function run({\n  defaultTimeout,\n  filterStackTraces,\n  hookParameter,\n  step,\n  stepDefinition,\n  world,\n}: IRunOptions): Promise<messages.TestStepResult> {\n  const stopwatch = create().start()\n  let error: any, result: any, invocationData: IGetInvocationDataResponse\n\n  try {\n    invocationData = await stepDefinition.getInvocationParameters({\n      hookParameter,\n      step,\n      world,\n    })\n  } catch (err) {\n    error = err\n  }\n\n  if (doesNotHaveValue(error)) {\n    const timeoutInMilliseconds = valueOrDefault(\n      stepDefinition.options.timeout,\n      defaultTimeout\n    )\n\n    if (invocationData.validCodeLengths.includes(stepDefinition.code.length)) {\n      const data = await UserCodeRunner.run({\n        argsArray: invocationData.parameters,\n        fn: stepDefinition.code,\n        thisArg: world,\n        timeoutInMilliseconds,\n      })\n      error = data.error\n      result = data.result\n    } else {\n      error = invocationData.getInvalidCodeLengthMessage()\n    }\n  }\n\n  const duration = stopwatch.stop().duration()\n  let status: messages.TestStepResultStatus\n  let details = {}\n  if (result === 'skipped') {\n    status = messages.TestStepResultStatus.SKIPPED\n  } else if (result === 'pending') {\n    status = messages.TestStepResultStatus.PENDING\n  } else if (doesHaveValue(error)) {\n    details = formatError(error, filterStackTraces)\n    status = messages.TestStepResultStatus.FAILED\n  } else {\n    status = messages.TestStepResultStatus.PASSED\n  }\n\n  return {\n    duration,\n    status,\n    ...details,\n  }\n}\n\nexport default { run }\n"]}