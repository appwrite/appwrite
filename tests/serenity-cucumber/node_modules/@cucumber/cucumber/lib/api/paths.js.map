{"version":3,"file":"paths.js","sourceRoot":"","sources":["../../src/api/paths.ts"],"names":[],"mappings":"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","sourcesContent":["import { promisify } from 'util'\nimport glob from 'glob'\nimport path from 'path'\nimport fs from 'mz/fs'\nimport { ISourcesCoordinates, ISupportCodeCoordinates } from './types'\nimport { ILogger } from '../logger'\n\nexport async function resolvePaths(\n  logger: ILogger,\n  cwd: string,\n  sources: Pick<ISourcesCoordinates, 'paths'>,\n  support: ISupportCodeCoordinates = {\n    requireModules: [],\n    requirePaths: [],\n    importPaths: [],\n  }\n): Promise<{\n  unexpandedFeaturePaths: string[]\n  featurePaths: string[]\n  requirePaths: string[]\n  importPaths: string[]\n}> {\n  const unexpandedFeaturePaths = await getUnexpandedFeaturePaths(\n    cwd,\n    sources.paths\n  )\n  const featurePaths: string[] = await expandFeaturePaths(\n    cwd,\n    unexpandedFeaturePaths\n  )\n  logger.debug('Found feature files based on configuration:', featurePaths)\n  const { requirePaths, importPaths } = await deriveSupportPaths(\n    cwd,\n    featurePaths,\n    support.requirePaths,\n    support.importPaths\n  )\n  logger.debug(\n    'Found support files to load via `require` based on configuration:',\n    requirePaths\n  )\n  logger.debug(\n    'Found support files to load via `import` based on configuration:',\n    importPaths\n  )\n  return {\n    unexpandedFeaturePaths,\n    featurePaths,\n    requirePaths,\n    importPaths,\n  }\n}\n\nasync function expandPaths(\n  cwd: string,\n  unexpandedPaths: string[],\n  defaultExtension: string\n): Promise<string[]> {\n  const expandedPaths = await Promise.all(\n    unexpandedPaths.map(async (unexpandedPath) => {\n      const matches = await promisify(glob)(unexpandedPath, {\n        absolute: true,\n        cwd,\n      })\n      const expanded = await Promise.all(\n        matches.map(async (match) => {\n          if (path.extname(match) === '') {\n            return await promisify(glob)(`${match}/**/*${defaultExtension}`)\n          }\n          return [match]\n        })\n      )\n      return expanded.flat()\n    })\n  )\n  const normalized = expandedPaths.flat().map((x) => path.normalize(x))\n  return [...new Set(normalized)]\n}\n\nasync function getUnexpandedFeaturePaths(\n  cwd: string,\n  args: string[]\n): Promise<string[]> {\n  if (args.length > 0) {\n    const nestedFeaturePaths = await Promise.all(\n      args.map(async (arg) => {\n        const filename = path.basename(arg)\n        if (filename[0] === '@') {\n          const filePath = path.join(cwd, arg)\n          const content = await fs.readFile(filePath, 'utf8')\n          return content.split('\\n').map((x) => x.trim())\n        }\n        return [arg]\n      })\n    )\n    const featurePaths = nestedFeaturePaths.flat()\n    if (featurePaths.length > 0) {\n      return featurePaths.filter((x) => x !== '')\n    }\n  }\n  return ['features/**/*.{feature,feature.md}']\n}\n\nfunction getFeatureDirectoryPaths(\n  cwd: string,\n  featurePaths: string[]\n): string[] {\n  const featureDirs = featurePaths.map((featurePath) => {\n    let featureDir = path.dirname(featurePath)\n    let childDir: string\n    let parentDir = featureDir\n    while (childDir !== parentDir) {\n      childDir = parentDir\n      parentDir = path.dirname(childDir)\n      if (path.basename(parentDir) === 'features') {\n        featureDir = parentDir\n        break\n      }\n    }\n    return path.relative(cwd, featureDir)\n  })\n  return [...new Set(featureDirs)]\n}\n\nasync function expandFeaturePaths(\n  cwd: string,\n  featurePaths: string[]\n): Promise<string[]> {\n  featurePaths = featurePaths.map((p) => p.replace(/(:\\d+)*$/g, '')) // Strip line numbers\n  return await expandPaths(cwd, featurePaths, '.feature')\n}\n\nasync function deriveSupportPaths(\n  cwd: string,\n  featurePaths: string[],\n  unexpandedRequirePaths: string[],\n  unexpandedImportPaths: string[]\n): Promise<{\n  requirePaths: string[]\n  importPaths: string[]\n}> {\n  if (\n    unexpandedRequirePaths.length === 0 &&\n    unexpandedImportPaths.length === 0\n  ) {\n    const defaultPaths = getFeatureDirectoryPaths(cwd, featurePaths)\n    const requirePaths = await expandPaths(cwd, defaultPaths, '.js')\n    const importPaths = await expandPaths(cwd, defaultPaths, '.mjs')\n    return { requirePaths, importPaths }\n  }\n  const requirePaths =\n    unexpandedRequirePaths.length > 0\n      ? await expandPaths(cwd, unexpandedRequirePaths, '.js')\n      : []\n  const importPaths =\n    unexpandedImportPaths.length > 0\n      ? await expandPaths(cwd, unexpandedImportPaths, '.@(js|cjs|mjs)')\n      : []\n  return { requirePaths, importPaths }\n}\n"]}