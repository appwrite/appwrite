{"version":3,"file":"json_formatter.js","sourceRoot":"","sources":["../../src/formatter/json_formatter.ts"],"names":[],"mappings":"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","sourcesContent":["import Formatter, { IFormatterOptions } from './'\nimport { formatLocation, GherkinDocumentParser, PickleParser } from './helpers'\nimport * as messages from '@cucumber/messages'\nimport {\n  getGherkinExampleRuleMap,\n  getGherkinScenarioLocationMap,\n} from './helpers/gherkin_document_parser'\nimport { ITestCaseAttempt } from './helpers/event_data_collector'\nimport { doesHaveValue, doesNotHaveValue } from '../value_checker'\nimport { parseStepArgument } from '../step_arguments'\nimport { durationToNanoseconds } from './helpers/duration_helpers'\n\nconst { getGherkinStepMap, getGherkinScenarioMap } = GherkinDocumentParser\n\nconst { getScenarioDescription, getPickleStepMap, getStepKeyword } =\n  PickleParser\n\nexport interface IJsonFeature {\n  description: string\n  elements: IJsonScenario[]\n  id: string\n  keyword: string\n  line: number\n  name: string\n  tags: IJsonTag[]\n  uri: string\n}\n\nexport interface IJsonScenario {\n  description: string\n  id: string\n  keyword: string\n  line: number\n  name: string\n  steps: IJsonStep[]\n  tags: IJsonTag[]\n  type: string\n}\n\nexport interface IJsonStep {\n  arguments?: any // TODO\n  embeddings?: any // TODO\n  hidden?: boolean\n  keyword?: string // TODO, not optional\n  line?: number\n  match?: any // TODO\n  name?: string\n  result?: any // TODO\n}\n\nexport interface IJsonTag {\n  name: string\n  line: number\n}\n\ninterface IBuildJsonFeatureOptions {\n  feature: messages.Feature\n  elements: IJsonScenario[]\n  uri: string\n}\n\ninterface IBuildJsonScenarioOptions {\n  feature: messages.Feature\n  gherkinScenarioMap: Record<string, messages.Scenario>\n  gherkinExampleRuleMap: Record<string, messages.Rule>\n  gherkinScenarioLocationMap: Record<string, messages.Location>\n  pickle: messages.Pickle\n  steps: IJsonStep[]\n}\n\ninterface IBuildJsonStepOptions {\n  isBeforeHook: boolean\n  gherkinStepMap: Record<string, messages.Step>\n  pickleStepMap: Record<string, messages.PickleStep>\n  testStep: messages.TestStep\n  testStepAttachments: messages.Attachment[]\n  testStepResult: messages.TestStepResult\n}\n\ninterface UriToTestCaseAttemptsMap {\n  [uri: string]: ITestCaseAttempt[]\n}\n\nexport default class JsonFormatter extends Formatter {\n  public static readonly documentation: string =\n    'Prints the feature as JSON. The JSON format is in maintenance mode. Please consider using the message formatter with the standalone json-formatter (https://github.com/cucumber/json-formatter).'\n\n  constructor(options: IFormatterOptions) {\n    super(options)\n    options.eventBroadcaster.on('envelope', (envelope: messages.Envelope) => {\n      if (doesHaveValue(envelope.testRunFinished)) {\n        this.onTestRunFinished()\n      }\n    })\n  }\n\n  convertNameToId(obj: messages.Feature | messages.Pickle): string {\n    return obj.name.replace(/ /g, '-').toLowerCase()\n  }\n\n  formatDataTable(dataTable: messages.PickleTable): any {\n    return {\n      rows: dataTable.rows.map((row) => ({\n        cells: row.cells.map((x) => x.value),\n      })),\n    }\n  }\n\n  formatDocString(\n    docString: messages.PickleDocString,\n    gherkinStep: messages.Step\n  ): any {\n    return {\n      content: docString.content,\n      line: gherkinStep.docString.location.line,\n    }\n  }\n\n  formatStepArgument(\n    stepArgument: messages.PickleStepArgument,\n    gherkinStep: messages.Step\n  ): any {\n    if (doesNotHaveValue(stepArgument)) {\n      return []\n    }\n    return [\n      parseStepArgument<any>(stepArgument, {\n        dataTable: (dataTable) => this.formatDataTable(dataTable),\n        docString: (docString) => this.formatDocString(docString, gherkinStep),\n      }),\n    ]\n  }\n\n  onTestRunFinished(): void {\n    const groupedTestCaseAttempts: UriToTestCaseAttemptsMap = {}\n    this.eventDataCollector\n      .getTestCaseAttempts()\n      .forEach((testCaseAttempt: ITestCaseAttempt) => {\n        if (!testCaseAttempt.willBeRetried) {\n          const uri = testCaseAttempt.pickle.uri\n          if (doesNotHaveValue(groupedTestCaseAttempts[uri])) {\n            groupedTestCaseAttempts[uri] = []\n          }\n          groupedTestCaseAttempts[uri].push(testCaseAttempt)\n        }\n      })\n    const features = Object.keys(groupedTestCaseAttempts).map((uri) => {\n      const group = groupedTestCaseAttempts[uri]\n      const { gherkinDocument } = group[0]\n      const gherkinStepMap = getGherkinStepMap(gherkinDocument)\n      const gherkinScenarioMap = getGherkinScenarioMap(gherkinDocument)\n      const gherkinExampleRuleMap = getGherkinExampleRuleMap(gherkinDocument)\n      const gherkinScenarioLocationMap =\n        getGherkinScenarioLocationMap(gherkinDocument)\n      const elements = group.map((testCaseAttempt: ITestCaseAttempt) => {\n        const { pickle } = testCaseAttempt\n        const pickleStepMap = getPickleStepMap(pickle)\n        let isBeforeHook = true\n        const steps = testCaseAttempt.testCase.testSteps.map((testStep) => {\n          isBeforeHook = isBeforeHook && !doesHaveValue(testStep.pickleStepId)\n          return this.getStepData({\n            isBeforeHook,\n            gherkinStepMap,\n            pickleStepMap,\n            testStep,\n            testStepAttachments: testCaseAttempt.stepAttachments[testStep.id],\n            testStepResult: testCaseAttempt.stepResults[testStep.id],\n          })\n        })\n        return this.getScenarioData({\n          feature: gherkinDocument.feature,\n          gherkinScenarioLocationMap,\n          gherkinExampleRuleMap,\n          gherkinScenarioMap,\n          pickle,\n          steps,\n        })\n      })\n      return this.getFeatureData({\n        feature: gherkinDocument.feature,\n        elements,\n        uri,\n      })\n    })\n    this.log(JSON.stringify(features, null, 2))\n  }\n\n  getFeatureData({\n    feature,\n    elements,\n    uri,\n  }: IBuildJsonFeatureOptions): IJsonFeature {\n    return {\n      description: feature.description,\n      elements,\n      id: this.convertNameToId(feature),\n      line: feature.location.line,\n      keyword: feature.keyword,\n      name: feature.name,\n      tags: this.getFeatureTags(feature),\n      uri,\n    }\n  }\n\n  getScenarioData({\n    feature,\n    gherkinScenarioLocationMap,\n    gherkinExampleRuleMap,\n    gherkinScenarioMap,\n    pickle,\n    steps,\n  }: IBuildJsonScenarioOptions): IJsonScenario {\n    const description = getScenarioDescription({\n      pickle,\n      gherkinScenarioMap,\n    })\n    return {\n      description,\n      id: this.formatScenarioId({ feature, pickle, gherkinExampleRuleMap }),\n      keyword: gherkinScenarioMap[pickle.astNodeIds[0]].keyword,\n      line: gherkinScenarioLocationMap[\n        pickle.astNodeIds[pickle.astNodeIds.length - 1]\n      ].line,\n      name: pickle.name,\n      steps,\n      tags: this.getScenarioTags({ feature, pickle, gherkinScenarioMap }),\n      type: 'scenario',\n    }\n  }\n\n  private formatScenarioId({\n    feature,\n    pickle,\n    gherkinExampleRuleMap,\n  }: {\n    feature: messages.Feature\n    pickle: messages.Pickle\n    gherkinExampleRuleMap: Record<string, messages.Rule>\n  }): string {\n    let parts: any[]\n    const rule = gherkinExampleRuleMap[pickle.astNodeIds[0]]\n    if (doesHaveValue(rule)) {\n      parts = [feature, rule, pickle]\n    } else {\n      parts = [feature, pickle]\n    }\n    return parts.map((part) => this.convertNameToId(part)).join(';')\n  }\n\n  getStepData({\n    isBeforeHook,\n    gherkinStepMap,\n    pickleStepMap,\n    testStep,\n    testStepAttachments,\n    testStepResult,\n  }: IBuildJsonStepOptions): IJsonStep {\n    const data: IJsonStep = {}\n    if (doesHaveValue(testStep.pickleStepId)) {\n      const pickleStep = pickleStepMap[testStep.pickleStepId]\n      data.arguments = this.formatStepArgument(\n        pickleStep.argument,\n        gherkinStepMap[pickleStep.astNodeIds[0]]\n      )\n      data.keyword = getStepKeyword({ pickleStep, gherkinStepMap })\n      data.line = gherkinStepMap[pickleStep.astNodeIds[0]].location.line\n      data.name = pickleStep.text\n    } else {\n      data.keyword = isBeforeHook ? 'Before' : 'After'\n      data.hidden = true\n    }\n    if (\n      doesHaveValue(testStep.stepDefinitionIds) &&\n      testStep.stepDefinitionIds.length === 1\n    ) {\n      const stepDefinition = this.supportCodeLibrary.stepDefinitions.find(\n        (s) => s.id === testStep.stepDefinitionIds[0]\n      )\n      data.match = { location: formatLocation(stepDefinition) }\n    }\n    const { message, status } = testStepResult\n    data.result = {\n      status: messages.TestStepResultStatus[status].toLowerCase(),\n    }\n    if (doesHaveValue(testStepResult.duration)) {\n      data.result.duration = durationToNanoseconds(testStepResult.duration)\n    }\n    if (\n      status === messages.TestStepResultStatus.FAILED &&\n      doesHaveValue(message)\n    ) {\n      data.result.error_message = message\n    }\n    if (testStepAttachments?.length > 0) {\n      data.embeddings = testStepAttachments.map((attachment) => ({\n        data: attachment.body,\n        mime_type: attachment.mediaType,\n      }))\n    }\n    return data\n  }\n\n  getFeatureTags(feature: messages.Feature): IJsonTag[] {\n    return feature.tags.map((tagData) => ({\n      name: tagData.name,\n      line: tagData.location.line,\n    }))\n  }\n\n  getScenarioTags({\n    feature,\n    pickle,\n    gherkinScenarioMap,\n  }: {\n    feature: messages.Feature\n    pickle: messages.Pickle\n    gherkinScenarioMap: Record<string, messages.Scenario>\n  }): IJsonTag[] {\n    const scenario = gherkinScenarioMap[pickle.astNodeIds[0]]\n\n    return pickle.tags.map(\n      (tagData: messages.PickleTag): IJsonTag =>\n        this.getScenarioTag(tagData, feature, scenario)\n    )\n  }\n\n  private getScenarioTag(\n    tagData: messages.PickleTag,\n    feature: messages.Feature,\n    scenario: messages.Scenario\n  ): IJsonTag {\n    const byAstNodeId = (tag: messages.Tag): boolean =>\n      tag.id === tagData.astNodeId\n    const flatten = (\n      acc: messages.Tag[],\n      val: messages.Tag[]\n    ): messages.Tag[] => acc.concat(val)\n\n    const tag =\n      feature.tags.find(byAstNodeId) ||\n      scenario.tags.find(byAstNodeId) ||\n      scenario.examples\n        .map((e) => e.tags)\n        .reduce(flatten, [])\n        .find(byAstNodeId)\n\n    return {\n      name: tagData.name,\n      line: tag?.location?.line,\n    }\n  }\n}\n"]}